<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>VR Museum</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- NO VR BUTTON HERE AS PER USER REQUEST. AUTO-ENTRY VIA PERSISTENCE PARAMETER -->

  <script>
    // Helper to handle VR persistence
    function checkAutoVR() {
      const urlParams = new URLSearchParams(window.location.search);
      const isVRParam = urlParams.get('vr') === 'true';
      const scene = document.querySelector('a-scene');

      if (isVRParam) {
        const triggerVR = () => {
          // Attempt immediate entry
          scene.enterVR().catch(err => {
            console.log("Auto-VR entry blocked, waiting for user interaction...");
            setupInteractionTrigger();
          });
        };

        const setupInteractionTrigger = () => {
          // Create an invisible overlay to catch the first user gesture
          if (document.getElementById('gesture-overlay')) return;
          const overlay = document.createElement('div');
          overlay.id = 'gesture-overlay';
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100%';
          overlay.style.height = '100%';
          overlay.style.zIndex = '10000';
          overlay.style.background = 'transparent';
          document.body.appendChild(overlay);

          overlay.addEventListener('click', () => {
            scene.enterVR();
            document.body.removeChild(overlay);
          });
        };

        if (scene.hasLoaded) triggerVR();
        else scene.addEventListener('loaded', triggerVR);
      }
    }

    window.addEventListener('load', checkAutoVR);
  </script>

  <script>
    /* ===============================
       MUSEUM FRAME COMPONENT
    =============================== */
    AFRAME.registerComponent('museum-frame', {
      schema: {
        type: { type: 'string', default: 'modern' }, // classic, modern, premium
        src: { type: 'asset' },
        title: { type: 'string', default: '' },
        description: { type: 'string', default: '' },
        width: { type: 'number', default: 2 },
        height: { type: 'number', default: 3 },
        focusDistance: { type: 'number', default: 3 }
      },

      init: function () {
        const data = this.data;
        const el = this.el;

        // --- Frame Border/Backing ---
        const frame = document.createElement('a-box');
        let frameColor = '#222';
        let frameDepth = 0.1;
        let padding = 0.2;

        if (data.type === 'classic') {
          frameColor = '#3d2b1f';
          frameDepth = 0.15;
          padding = 0.25;
        } else if (data.type === 'premium') {
          frameColor = '#d4af37';
          frameDepth = 0.2;
          padding = 0.3;
        }

        frame.setAttribute('width', data.width + padding);
        frame.setAttribute('height', data.height + padding);
        frame.setAttribute('depth', frameDepth);
        frame.setAttribute('material', { color: frameColor, roughness: 0.3, metalness: 0.5 });
        el.appendChild(frame);

        // --- Content Inside Frame ---
        const contentContainer = document.createElement('a-entity');
        contentContainer.setAttribute('position', `0 0 ${frameDepth / 2 + 0.01}`);
        el.appendChild(contentContainer);

        if (data.src) {
          // Display Image
          const image = document.createElement('a-image');
          image.setAttribute('src', data.src);
          image.setAttribute('width', data.width);
          image.setAttribute('height', data.height);
          image.setAttribute('class', 'clickable');
          image.setAttribute('voice-info', { text: data.description || data.title });
          contentContainer.appendChild(image);
          this.setupFocus(image, data.focusDistance);
        } else {
          // Display Text Plaque (No image)
          const plaque = document.createElement('a-plane');
          plaque.setAttribute('width', data.width);
          plaque.setAttribute('height', data.height);
          plaque.setAttribute('material', { color: '#f5f5dc', shader: 'flat' }); // Beige plaque background
          plaque.setAttribute('class', 'clickable');
          plaque.setAttribute('voice-info', { text: data.description || data.title });
          contentContainer.appendChild(plaque);

          const text = document.createElement('a-text');
          text.setAttribute('value', data.description || data.title);
          text.setAttribute('color', '#1a1a1a'); // Dark grey for readability
          text.setAttribute('align', 'center');
          text.setAttribute('width', data.width * 0.85); // Padding inside plaque
          text.setAttribute('wrap-count', 24); // Bold/Clear wrapping
          text.setAttribute('position', '0 0 0.02');
          text.setAttribute('font', 'kelsonsans');
          contentContainer.appendChild(text);

          this.setupFocus(plaque, data.focusDistance);
        }

        // --- Spotlight ---
        const light = document.createElement('a-entity');
        light.setAttribute('light', {
          type: 'spot',
          color: '#fff',
          intensity: 1.8,
          distance: 12,
          angle: 45,
          penumbra: 0.5
        });
        light.setAttribute('position', `0 ${data.height / 2 + 1.2} 2.5`);
        light.setAttribute('rotation', '-35 0 0');
        el.appendChild(light);
      },

      setupFocus: function (targetEl, distance) {
        const el = this.el;
        el.addEventListener('loaded', () => {
          const worldPos = new THREE.Vector3();
          el.object3D.getWorldPosition(worldPos);
          const worldRot = el.object3D.rotation;
          const offsetZ = Math.cos(worldRot.y) * distance;
          const offsetX = Math.sin(worldRot.y) * distance;

          targetEl.setAttribute('look-focus', {
            targetx: worldPos.x + offsetX,
            targetz: worldPos.z + offsetZ
          });
        });
      }
    });

    /* ===============================
       RECTANGULAR WALLS
    =============================== */
    AFRAME.registerComponent('rectangular-walls', {
      init: function () {
        const el = this.el;
        const width = 20;
        const depth = 24;
        const height = 7;

        const walls = [
          { pos: `0 ${height / 2} ${-depth / 2}`, rot: '0 0 0', w: width, h: height, name: 'back' },
          { pos: `0 ${height / 2} ${depth / 2}`, rot: '0 180 0', w: width, h: height, name: 'front' },
          { pos: `${-width / 2} ${height / 2} 0`, rot: '0 90 0', w: depth, h: height, name: 'left' },
          { pos: `${width / 2} ${height / 2} 0`, rot: '0 -90 0', w: depth, h: height, name: 'right' }
        ];

        walls.forEach(w => {
          const wall = document.createElement('a-plane');
          wall.setAttribute('position', w.pos);
          wall.setAttribute('rotation', w.rot);
          wall.setAttribute('width', w.w);
          wall.setAttribute('height', w.h);
          wall.setAttribute('material', {
            color: '#4a2c2c',
            roughness: 0.8,
            side: 'double'
          });
          el.appendChild(wall);
        });
      }
    });

    /* ===============================
       PARQUET FLOOR
    =============================== */
    AFRAME.registerComponent('parquet-floor', {
      init: function () {
        const el = this.el;
        const tileSize = 2.0;
        const planksPerTile = 3;
        const plankW = tileSize / planksPerTile;
        const floorSize = 30;
        const colors = ['#e3c08b', '#d4a460', '#c79248', '#b37d36'];

        for (let x = -floorSize / 2; x < floorSize / 2; x += tileSize) {
          for (let z = -floorSize / 2; z < floorSize / 2; z += tileSize) {
            const isVertical = (Math.round((x + floorSize / 2) / tileSize) + Math.round((z + floorSize / 2) / tileSize)) % 2 === 0;
            for (let i = 0; i < planksPerTile; i++) {
              const plank = document.createElement('a-plane');
              const offset = (i * plankW) - (tileSize / 2) + (plankW / 2);
              if (isVertical) {
                plank.setAttribute('width', plankW - 0.015);
                plank.setAttribute('height', tileSize - 0.015);
                plank.setAttribute('position', `${x + offset} 0.005 ${z}`);
              } else {
                plank.setAttribute('width', tileSize - 0.015);
                plank.setAttribute('height', plankW - 0.015);
                plank.setAttribute('position', `${x} 0.005 ${z + offset}`);
              }
              plank.setAttribute('rotation', '-90 0 0');
              plank.setAttribute('material', {
                color: colors[Math.floor(Math.random() * colors.length)],
                roughness: 0.3,
                metalness: 0.1,
                shader: 'standard'
              });
              el.appendChild(plank);
            }
          }
        }
      }
    });

    /* ===============================
       TELEPORT
    =============================== */
    AFRAME.registerComponent('teleport', {
      init: function () {
        this.el.addEventListener('click', () => {
          const target = this.el.getAttribute('data-target');
          if (target) {
            const isVR = this.el.sceneEl.is('vr-mode');
            const finalURL = isVR ? target + "?vr=true" : target;
            window.location.href = finalURL;
          } else {
            const rig = document.querySelector('#rig');
            const p = this.el.getAttribute('position');
            rig.setAttribute('position', { x: p.x, y: 0, z: p.z });
          }
        });
      }
    });

    /* ===============================
       VOICE NARRATION
    =============================== */
    AFRAME.registerComponent('voice-info', {
      schema: { text: { type: 'string' } },
      speak: function () {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(this.data.text);
        msg.rate = 1;
        window.speechSynthesis.speak(msg);
      }
    });

    /* ===============================
       LOOK FOCUS
    =============================== */
    AFRAME.registerComponent('look-focus', {
      schema: { targetx: { type: 'number' }, targetz: { type: 'number' } },
      init: function () {
        this.timer = null;
        this.el.addEventListener('mouseenter', () => {
          this.timer = setTimeout(() => {
            const rig = document.querySelector('#rig');
            rig.setAttribute('position', { x: this.data.targetx, y: 1.2, z: this.data.targetz });
            setTimeout(() => { this.el.components['voice-info']?.speak(); }, 1000);
          }, 2500);
        });
        this.el.addEventListener('mouseleave', () => { clearTimeout(this.timer); });
      }
    });

    /* ===============================
       QUIZ MANAGER
    =============================== */
    AFRAME.registerComponent('quiz-manager', {
      init: function () {
        this.score = 0;
        this.currentQuestionIndex = 0;
        this.canClick = true;
        this.questions = [
          {
            q: "When was Gangadharrao Deshpande born?",
            a: ["31 March 1871", "15 August 1947", "26 January 1950", "2 October 1869"],
            correct: 0
          },
          {
            q: "He is known as the 'Lion of...'?",
            a: ["Maharashtra", "Karnataka", "Punjab", "India"],
            correct: 1
          },
          {
            q: "What was his father's profession?",
            a: ["Teacher", "Doctor", "Lawyer", "Engineer"],
            correct: 2
          },
          {
            q: "In which village was he born?",
            a: ["Belgaum", "Hudli", "Pune", "Bangalore"],
            correct: 1
          },
          {
            q: "He led movements against which rule?",
            a: ["French", "British", "Portuguese", "Dutch"],
            correct: 1
          }
        ];

        this.questionText = this.el.querySelector('.quiz-question');
        this.options = this.el.querySelectorAll('.quiz-option');
        this.feedbackText = this.el.querySelector('.quiz-feedback');

        this.options.forEach((opt, i) => {
          opt.addEventListener('click', () => { if (this.canClick) this.checkAnswer(i); });
        });

        this.showQuestion();
      },

      showQuestion: function () {
        if (this.currentQuestionIndex >= this.questions.length) {
          this.showFinalScore();
          return;
        }
        this.canClick = true;
        const qData = this.questions[this.currentQuestionIndex];
        this.questionText.setAttribute('value', qData.q);
        this.feedbackText.setAttribute('value', 'Focus on an answer to select');
        this.feedbackText.setAttribute('color', '#aaa');

        this.options.forEach((opt, i) => {
          opt.setAttribute('visible', true);
          opt.setAttribute('material', 'color', '#2c3e50');
          const textEl = opt.querySelector('a-text');
          if (textEl) {
            textEl.setAttribute('value', qData.a[i]);
            textEl.setAttribute('color', '#fff');
          }
        });
      },

      checkAnswer: function (index) {
        if (!this.canClick) return;
        this.canClick = false;
        const qData = this.questions[this.currentQuestionIndex];
        const options = this.options;
        if (index === qData.correct) {
          this.score++;
          options[index].setAttribute('material', 'color', '#2ecc71');
          this.feedbackText.setAttribute('value', 'Correct!');
          this.feedbackText.setAttribute('color', '#2ecc71');
        } else {
          options[index].setAttribute('material', 'color', '#e74c3c');
          options[qData.correct].setAttribute('material', 'color', '#2ecc71');
          this.feedbackText.setAttribute('value', 'Actually: ' + qData.a[qData.correct]);
          this.feedbackText.setAttribute('color', '#e74c3c');
        }
        this.speak(index === qData.correct ? "Correct!" : "Oops. The answer is " + qData.a[qData.correct]);
        this.currentQuestionIndex++;
        setTimeout(() => this.showQuestion(), 2500);
      },

      showFinalScore: function () {
        this.questionText.setAttribute('value', 'Quiz Completed!');
        this.feedbackText.setAttribute('value', `Final Score: ${this.score} / ${this.questions.length}`);
        this.feedbackText.setAttribute('color', '#f1c40f');
        this.options.forEach(opt => opt.setAttribute('visible', false));
        this.speak(`Well done. You scored ${this.score} out of 5.`);
      },

      speak: function (text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.rate = 1.1;
        window.speechSynthesis.speak(msg);
      }
    });

    /* ===============================
       ENTRY VOICE ANNOUNCEMENT
    =============================== */
    AFRAME.registerComponent('entry-voice', {
      init: function () {
        this.el.addEventListener('loaded', () => {
          setTimeout(() => {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance("You're Entering into Next Section");
            msg.rate = 1;
            window.speechSynthesis.speak(msg);
          }, 1500);
        });
      }
    });
  </script>
</head>

<body onload="window.speechSynthesis.getVoices()">
  <a-scene entry-voice background="color:#000" vr-mode-ui="enabled:false"
    renderer="precision: mediump; antialias: false">

    <!-- ASSETS -->
    <a-assets>
      <img id="my-art" src="frame1.jpg">
      <img id="my-art2" src="frame2.jpg">
      <img id="my-art3" src="frame3.jpg">
      <img id="statue-img" src="Screenshot_2026-02-24_173909-removebg-preview.png">
    </a-assets>

    <!-- LIGHT -->
    <a-entity light="type: ambient; intensity: 1"></a-entity>

    <!-- FLOOR -->
    <a-entity parquet-floor></a-entity>

    <!-- CEILING -->
    <a-circle rotation="90 0 0" radius="16" position="0 6 0"
      material="shader:standard; color:#d4eaf7; opacity:0.7; transparent:true; side:double"></a-circle>

    <!-- WALLS -->
    <a-entity rectangular-walls></a-entity>

    <!-- QUIZ SYSTEM (Front Wall, Right Side, Premium Theme) -->
    <a-entity id="quiz-board" quiz-manager position="6 3 11.8" rotation="0 180 0">
      <a-plane width="4.5" height="4" material="color: #1a1a2e; roughness: 0.1; metalness: 0.9; opacity: 0.95">
        <a-text value="MUSEUM QUIZ - 1 " position="0 1.7 0.02" align="center" width="7" color="#f1c40f"
          font="exo2bold"></a-text>
      </a-plane>
      <a-text class="quiz-question" value="Loading question..." position="-2.1 0.8 0.05" align="left" width="4.3"
        wrap-count="20" color="#fff"></a-text>
      <a-entity class="options-container" position="0 -0.6 0.05">
        <a-plane class="quiz-option clickable" position="-1.1 0.4 0" width="2.1" height="0.5"
          material="color: #2c3e50; roughness: 0.6">
          <a-text value="Option A" align="center" color="#fff" width="3.5"></a-text>
        </a-plane>
        <a-plane class="quiz-option clickable" position="1.1 0.4 0" width="2.1" height="0.5"
          material="color: #2c3e50; roughness: 0.6">
          <a-text value="Option B" align="center" color="#fff" width="3.5"></a-text>
        </a-plane>
        <a-plane class="quiz-option clickable" position="-1.1 -0.4 0" width="2.1" height="0.5"
          material="color: #2c3e50; roughness: 0.6">
          <a-text value="Option C" align="center" color="#fff" width="3.5"></a-text>
        </a-plane>
        <a-plane class="quiz-option clickable" position="1.1 -0.4 0" width="2.1" height="0.5"
          material="color: #2c3e50; roughness: 0.6">
          <a-text value="Option D" align="center" color="#fff" width="3.5"></a-text>
        </a-plane>
      </a-entity>
      <a-text class="quiz-feedback" value="Focus on an answer to select" position="0 -1.6 0.05" align="center" width="4"
        color="#aaa"></a-text>
    </a-entity>

    <!-- TELEPORT BACK TO ENTRANCE (Below Quiz area) -->
    <a-cylinder position="0 0.05 11" radius="0.5" height="0.1" material="color: green" class="clickable" teleport
      data-target="entrance.html"></a-cylinder>
    <a-text value="Return to Entrance" position="0 1 11" align="center" color="#fff" rotation="0 180 0"></a-text>

    <!-- EXHIBIT FRAMES -->
    <!-- Back Wall -->
    <a-entity
      museum-frame="src: #my-art; type: premium; title: Artifact Collection; description: This artifact belongs to the ancient royal collection.; width: 3; height: 4.5"
      position="0 3.5 -11.9" rotation="0 0 0"></a-entity>
    <a-entity
      museum-frame="type: classic; title: Early Revolutionary Years; description: Gangadharrao Deshpande possessed a solid education and exceptional leadership qualities, which propelled him to the forefront of the struggle for national freedom."
      position="-6 3 -11.9" rotation="0 0 0"></a-entity>
    <a-entity
      museum-frame="src: #my-art3; type: modern; title: Ancient Weapons; description: These are ancient weapons showing battlefield evolution through history."
      position="6 3 -11.9" rotation="0 0 0"></a-entity>

    <!-- Left Wall -->
    <a-entity
      museum-frame="type: classic; title: Education & Leadership; description: Gangadhar Rao Deshpande pursued early education in Belgaum later he moves to Pune for higher studies. He holds a dual degree: BA and LLB."
      position="-9.9 3 -4" rotation="0 90 0"></a-entity>
    <a-entity
      museum-frame="type: classic; title: Family Background; description: Gangadharrao Deshapande's father was Balakrishna Deshpande, a well-known lawyer and founder member of Belgaum Vakeel's Association. He was a Vatandar in Hudli, Belgaum, Karnataka."
      position="-9.9 3 0" rotation="0 90 0"></a-entity>
    <a-entity
      museum-frame="type: classic; title: Gangadharrao Deshpande; description: Gangadharrao Balkrishna Deshpande was born on 31 March 1871 into a Kannada-speaking Deshastha Rigvedi Brahmin family in Hudli, Belgaum, Karnataka."
      position="-9.9 3 4" rotation="0 90 0"></a-entity>

    <!-- Right Wall -->
    <a-entity
      museum-frame="src: #my-art3; type: premium; title: Right Gallery I; description: Masterpiece showcasing the peak of craftsmanship."
      position="9.9 3 -4" rotation="0 -90 0"></a-entity>
    <a-entity
      museum-frame="src: #my-art; type: classic; title: Right Gallery II; description: Historical documentation of local heritage."
      position="9.9 3 4" rotation="0 -90 0"></a-entity>

    <!-- Navigation Points -->
    <a-cylinder position="0 0.05 5" radius="0.5" height="0.1" material="color: blue" teleport
      class="clickable"></a-cylinder>
    <a-cylinder position="0 0.05 -3" radius="0.5" height="0.1" material="color: blue" teleport
      class="clickable"></a-cylinder>
    <a-cylinder position="-6 0.05 -8" radius="0.5" height="0.1" material="color: blue; opacity: 0.6" teleport
      class="clickable"></a-cylinder>
    <a-cylinder position="6 0.05 -8" radius="0.5" height="0.1" material="color: blue; opacity: 0.6" teleport
      class="clickable"></a-cylinder>
    <a-cylinder position="-6 0.05 4" radius="0.5" height="0.1" material="color: blue; opacity: 0.6" teleport
      class="clickable"></a-cylinder>
    <a-cylinder position="6 0.05 4" radius="0.5" height="0.1" material="color: blue; opacity: 0.6" teleport
      class="clickable"></a-cylinder>

    <!-- CAMERA RIG -->
    <a-entity id="rig" position="0 0 6">
      <a-entity camera look-controls position="0 1.6 0" rotation="0 180 0">
        <a-cursor fuse="true" fuse-timeout="2000" raycaster="objects: .clickable, [teleport]"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03" material="color: #fff; shader: flat"
          animation__fusing="property: geometry.radiusInner; from: 0.02; to: 0.001; dur: 2000; startEvents: fusing"
          animation__mouseleave="property: geometry.radiusInner; to: 0.02; dur: 200; startEvents: mouseleave">
        </a-cursor>
      </a-entity>
    </a-entity>

  </a-scene>
</body>

</html>
